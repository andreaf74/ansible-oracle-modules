---
- name: "Test parameters modifications"
  hosts: localhost
  connection: docker
  gather_facts: no
  tags: "test1"

  tasks:
    - name: "change open_cursors"
      oracle_parameter:
        service_name: "xepdb1"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "open_cursors"
        value: "351"
        state: "defined"

    - name: "change blank_trimming"
      oracle_parameter:
        service_name: "xepdb1"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "blank_trimming"
        value: "TRUE"
        state: "defined"
        scope: "spfile"

    - name: "change nls_language"
      oracle_parameter:
        service_name: "xepdb1"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "nls_language"
        value: "GERMAN"
        state: "defined"
        scope: "spfile"

    - name: "change db_recovery_file_dest (cdb only)"
      oracle_parameter:
        service_name: "xe"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "db_recovery_file_dest"
        value: "+FRA"
        state: "defined"
        scope: "spfile"

    - name: "change _disable_directory_link_check (cdb only)"
      oracle_parameter:
        service_name: "xe"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "_disable_directory_link_check"
        value: "TRUE"
        state: "defined"
        scope: "spfile"

- name: "Test parameters reset"
  hosts: localhost
  connection: docker
  gather_facts: no
  tags: "test2"

  tasks:
    - name: "reset open_cursors"
      oracle_parameter:
        service_name: "xepdb1"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "open_cursors"
        state: "default"
        scope: "both"

    - name: "reset blank_trimming"
      oracle_parameter:
        service_name: "xepdb1"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "blank_trimming"
        state: "default"
        scope: "spfile"

    - name: "reset nls_language"
      oracle_parameter:
        service_name: "xepdb1"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "nls_language"
        state: "default"
        scope: "spfile"

    - name: "reset db_recovery_file_dest (cdb only)"
      oracle_parameter:
        service_name: "xe"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "db_recovery_file_dest"
        state: "default"
        scope: "spfile"

    - name: "reset _disable_directory_link_check (cdb only)"
      oracle_parameter:
        service_name: "xe"
        username: "sys"
        password: "password"
        mode: "sysdba"
        name: "_disable_directory_link_check"
        state: "default"
        scope: "spfile"

- name: "Test with no sysdba privileges"
  hosts: localhost
  connection: docker
  gather_facts: no
  tags: "test3"

  tasks:
    - name: "change _disable_directory_link_check (cdb only)"
      oracle_parameter:
        service_name: "xepdb1"
        username: "system_ansible"
        password: "system_ansible_password"
        mode: "normal"
        name: "_disable_directory_link_check"
        value: "TRUE"
        state: "defined"
        scope: "spfile"
      register: _
      failed_when: not _.failed or 'sysdba privileges needed' not in _.msg

    - name: "reset open_cursors"
      oracle_parameter:
        service_name: "xepdb1"
        username: "system_ansible"
        password: "system_ansible_password"
        mode: "normal"
        name: "open_cursors"
        state: "default"
...
